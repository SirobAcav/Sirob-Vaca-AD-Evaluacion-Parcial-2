<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Facturas</title>
<script src="js/app.js"></script>
<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
    }
    form {
        margin-bottom: 20px;
    }
    form select, form button {
        margin: 5px 0;
        padding: 8px;
    }

    #tablaFacturas {
        width: 100%;
        border-collapse: collapse;
    }
    #tablaFacturas thead, #tablaFacturas tbody tr {
        display: table;
        width: 100%;
        table-layout: fixed;
    }
    #tablaFacturas tbody {
        display: block;
        height: calc(100vh - 300px);
        overflow-y: auto;
    }
    #tablaFacturas thead {
        width: calc(100%); 
    }
    #tablaFacturas th, #tablaFacturas td {
        border: 1px solid #000;
        padding: 8px;
        text-align: left;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5);
        justify-content: center; align-items: center;
    }
    .modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 6px;
        width: 300px;
    }
    .modal-content select { width: 100%; margin-bottom: 10px; }
    .close { float: right; cursor: pointer; }
</style>
</head>
<body>
<h1>Facturas</h1>

<form id="formFactura">
    <select id="cliente_id" required>
        <option value="">Seleccione un cliente</option>
    </select>
    <select id="vehiculo_id" required>
        <option value="">Seleccione un vehiculo</option>
    </select>
    <select id="servicio_id" required>
        <option value="">Seleccione un servicio</option>
    </select>
    <select id="empleado_id" required>
        <option value="">Seleccione un empleado</option>
    </select>
    <button type="submit">Crear Factura</button>
</form>

<h2>Listado</h2>
<table border="1" id="tablaFacturas">
<thead>
    <tr>
        <th>ID</th><th>Cliente</th><th>Veh√≠culo</th><th>Servicio</th>
        <th>Empleado</th><th>Total</th><th>Fecha</th><th>PDF</th><th>Acciones</th>
    </tr>
</thead>
<tbody></tbody>
</table>

<div id="modalEditar" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <h3>Editar Factura</h3>
        <input type="hidden" id="edit_id">
        <select id="edit_cliente_id" required></select>
        <select id="edit_vehiculo_id" required></select>
        <select id="edit_servicio_id" required></select>
        <select id="edit_empleado_id" required></select>
        <button onclick="guardarEdicion()">Actualizar</button>
    </div>
</div>

<script>
let clientes=[], vehiculos=[], servicios=[], empleados=[];

window.onload = async () => {
    clientes = await cargarClientes();
    vehiculos = await cargarVehiculos();
    servicios = await cargarServicios();
    empleados = await cargarEmpleados();

    cargarSelect(clientes, "#cliente_id");
    cargarSelect(clientes, "#edit_cliente_id");
    cargarSelect(servicios, "#servicio_id");
    cargarSelect(servicios, "#edit_servicio_id");
    cargarSelect(empleados, "#empleado_id");
    cargarSelect(empleados, "#edit_empleado_id");

    cargarTabla();

    document.querySelector("#cliente_id").addEventListener("change", e => filtrarVehiculos(e.target.value, "#vehiculo_id"));
    document.querySelector("#edit_cliente_id").addEventListener("change", e => filtrarVehiculos(e.target.value, "#edit_vehiculo_id"));

    formFactura.onsubmit = async e => {
        e.preventDefault();
        await crearFacturaDesdeForm("#cliente_id","#vehiculo_id","#servicio_id","#empleado_id");
        formFactura.reset();
        cargarTabla();
    };
};

function cargarSelect(data, selector) {
    const sel = document.querySelector(selector);
    sel.innerHTML = '<option value="">Seleccione</option>';
    data.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = d.nombre || d.placa;
        sel.appendChild(opt);
    });
}

function filtrarVehiculos(clienteId, selector) {
    const sel = document.querySelector(selector);
    sel.innerHTML = '<option value="">Seleccione un vehiculo</option>';
    vehiculos.filter(v => v.cliente_id == clienteId).forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = v.marca + " " + v.modelo + " - " + v.placa;
        sel.appendChild(opt);
    });
}

async function cargarTabla() {
    const data = await cargarFacturas();
    const tbody = document.querySelector("#tablaFacturas tbody");
    tbody.innerHTML = "";
    data.forEach(f => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${f.id}</td>
            <td>${f.cliente}</td>
            <td>${f.vehiculo}</td>
            <td>${f.servicio}</td>
            <td>${f.empleado}</td>
            <td>$${f.total}</td>
            <td>${new Date(f.fecha).toLocaleString('es-ES')}</td>
            <td><button onclick="descargarFacturaPDF(${f.id})">PDF</button></td>
            <td>
                <button onclick="abrirModal(${f.id})">Editar</button>
                <button onclick="eliminarFactura(${f.id}).then(()=>cargarTabla())">Eliminar</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function abrirModal(id) {
    const f = await apiRequest(`facturas/${id}`);
    document.querySelector("#edit_id").value = f.id;
    document.querySelector("#edit_cliente_id").value = f.cliente_id;
    filtrarVehiculos(f.cliente_id,"#edit_vehiculo_id");
    document.querySelector("#edit_vehiculo_id").value = f.vehiculo_id;
    document.querySelector("#edit_servicio_id").value = f.servicio_id;
    document.querySelector("#edit_empleado_id").value = f.empleado_id;
    document.querySelector("#modalEditar").style.display = "flex";
}

function cerrarModal() {
    document.querySelector("#modalEditar").style.display = "none";
}

async function guardarEdicion() {
    const id = document.querySelector("#edit_id").value;
    const servicioSeleccionado = servicios.find(s => s.id == document.querySelector("#edit_servicio_id").value);
    const total = servicioSeleccionado ? parseFloat(servicioSeleccionado.costo) : 0;

    const facturaData = {
        cliente_id: document.querySelector("#edit_cliente_id").value,
        vehiculo_id: document.querySelector("#edit_vehiculo_id").value,
        servicio_id: document.querySelector("#edit_servicio_id").value,
        empleado_id: document.querySelector("#edit_empleado_id").value,
        total: total,
        servicios: [{ servicio_id: document.querySelector("#edit_servicio_id").value, cantidad: 1 }]
    };

    await actualizarFactura(id,facturaData);
    cerrarModal();
    cargarTabla();
}

async function crearFacturaDesdeForm(cId,vId,sId,eId){
    const servicioSeleccionado = servicios.find(s => s.id == document.querySelector(sId).value);
    const total = servicioSeleccionado ? parseFloat(servicioSeleccionado.costo) : 0;

    const facturaData = {
        cliente_id: document.querySelector(cId).value,
        vehiculo_id: document.querySelector(vId).value,
        servicio_id: document.querySelector(sId).value,
        empleado_id: document.querySelector(eId).value,
        total: total,
        servicios: [{ servicio_id: document.querySelector(sId).value, cantidad: 1 }]
    };

    await crearFactura(facturaData);
}
</script>
</body>
</html>
