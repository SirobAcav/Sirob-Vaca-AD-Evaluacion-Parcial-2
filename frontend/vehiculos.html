<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Vehículos</title>
    <script src="js/app.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        form {
            margin-bottom: 10px;
        }
        form input, form select, form button {
            padding: 5px;
            margin: 5px 0;
        }

        /* Tabla con altura completa */
        #tablaVehiculos {
            width: 100%;
            border-collapse: collapse;
        }
        #tablaVehiculos th, #tablaVehiculos td {
            border: 1px solid #000;
            padding: 8px;
            text-align: left;
        }

        /* Scroll en tbody */
        #tablaVehiculos tbody {
            display: block;
            height: calc(100vh - 250px); /* Ajusta según encabezado y formulario */
            overflow-y: auto;
        }
        #tablaVehiculos thead, #tablaVehiculos tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 6px;
            width: 300px;
        }
        .modal-content input, .modal-content select { width: 100%; margin-bottom: 10px; }
        .close { float: right; cursor: pointer; }
    </style>
</head>
<body>
<h1>Vehículos</h1>

<form id="formVehiculo">
    <select id="cliente_id" required>
        <option value="">Seleccione un cliente</option>
    </select>
    <input type="text" id="marca" placeholder="Marca" required>
    <input type="text" id="modelo" placeholder="Modelo" required>
    <input type="text" id="placa" placeholder="Placa" required>
    <button type="submit">Guardar</button>
</form>

<h2>Listado</h2>
<table border="1" id="tablaVehiculos">
<thead>
    <tr><th>ID</th><th>Cliente</th><th>Marca</th><th>Modelo</th><th>Placa</th><th>Acciones</th></tr>
</thead>
<tbody></tbody>
</table>

<!-- Modal para editar vehículo -->
<div id="modalEditar" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModal()">&times;</span>
        <h3>Editar Vehículo</h3>
        <input type="hidden" id="edit_id">
        <select id="edit_cliente_id" required></select>
        <input type="text" id="edit_marca" placeholder="Marca" required>
        <input type="text" id="edit_modelo" placeholder="Modelo" required>
        <input type="text" id="edit_placa" placeholder="Placa" required>
        <button onclick="guardarEdicion()">Actualizar</button>
    </div>
</div>

<script>
let clientes = [];
window.onload = async () => {
    clientes = await cargarClientes();
    cargarSelectClientes(document.querySelector("#cliente_id"));
    cargarSelectClientes(document.querySelector("#edit_cliente_id"));

    await cargarTablaVehiculos();

    document.querySelector("#formVehiculo").addEventListener("submit", async e => {
        e.preventDefault();
        await agregarVehiculo({
            cliente_id: cliente_id.value,
            marca: marca.value,
            modelo: modelo.value,
            placa: placa.value
        });
        document.querySelector("#formVehiculo").reset();
        await cargarTablaVehiculos();
    });
};

function cargarSelectClientes(select) {
    select.innerHTML = '<option value="">Seleccione un cliente</option>';
    clientes.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.id;
        opt.textContent = c.nombre;
        select.appendChild(opt);
    });
}

async function cargarTablaVehiculos() {
    const data = await cargarVehiculos();
    const tbody = document.querySelector("#tablaVehiculos tbody");
    tbody.innerHTML = "";
    data.forEach(v => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${v.id}</td>
            <td>${v.cliente}</td>
            <td>${v.marca}</td>
            <td>${v.modelo}</td>
            <td>${v.placa}</td>
            <td>
                <button onclick="abrirModal(${v.id})">Editar</button>
                <button onclick="eliminarVehiculo(${v.id}).then(()=>cargarTablaVehiculos())">Eliminar</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Modal
async function abrirModal(id) {
    const vehiculo = await apiRequest(`vehiculos/${id}`);
    document.querySelector("#edit_id").value = vehiculo.id;
    document.querySelector("#edit_cliente_id").value = vehiculo.cliente_id;
    document.querySelector("#edit_marca").value = vehiculo.marca;
    document.querySelector("#edit_modelo").value = vehiculo.modelo;
    document.querySelector("#edit_placa").value = vehiculo.placa;
    document.querySelector("#modalEditar").style.display = "flex";
}

function cerrarModal() {
    document.querySelector("#modalEditar").style.display = "none";
}

async function guardarEdicion() {
    const id = document.querySelector("#edit_id").value;
    const vehiculo = {
        cliente_id: document.querySelector("#edit_cliente_id").value,
        marca: document.querySelector("#edit_marca").value,
        modelo: document.querySelector("#edit_modelo").value,
        placa: document.querySelector("#edit_placa").value
    };
    await actualizarVehiculo(id, vehiculo);
    cerrarModal();
    await cargarTablaVehiculos();
}
</script>
</body>
</html>
